{"version":3,"sources":["../../src/highlight/highlighter.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["/**\n * Stateless, referentially-transparent highlighter utilities.\n * All functions accept the current highlights array and return a new array\n * (or a derived value) without mutating the input.\n * Framework-agnostic - no Vue/Quasar dependencies.\n */\n\nimport type { PassageHighlight } from '../types'\n\n/**\n * Complete passage tuple type\n */\nexport type PassageTuple = [number, number, number, number]\n\n/**\n * Generate a unique key for a passage\n */\nfunction getPassageKey(passage: PassageTuple): string {\n  return `${passage[0]}-${passage[1]}-${passage[2]}-${passage[3]}`\n}\n\n/**\n * Get all highlights that overlap with the given passage\n */\nexport function getOverlappingHighlights(\n  highlights: PassageHighlight[],\n  passage: PassageTuple\n): PassageHighlight[] {\n  const [book, chapter, start, end] = passage\n  return highlights.filter(h => {\n    const [hBook, hChapter, hStart, hEnd] = h.passage\n    if (hBook !== book || hChapter !== chapter) return false\n    return !(hEnd < start || hStart > end)\n  })\n}\n\n/**\n * Get the highlight that exactly matches the given passage\n */\nexport function getExactPassageHighlight(\n  highlights: PassageHighlight[],\n  passage: PassageTuple\n): PassageHighlight | undefined {\n  const [book, chapter, start, end] = passage\n  return highlights.find(h => {\n    const [b, c, hStart, hEnd] = h.passage\n    return b === book && c === chapter && hStart === start && hEnd === end\n  })\n}\n\n/**\n * Get the highlight that contains the given verse\n */\nexport function getHighlightForVerse(\n  highlights: PassageHighlight[],\n  book: number,\n  chapter: number,\n  verse: number\n): PassageHighlight | undefined {\n  return highlights.find(h => {\n    const [b, c, start, end] = h.passage\n    return b === book && c === chapter && verse >= start && verse <= end\n  })\n}\n\n/**\n * Get all highlights (identity function for API consistency)\n */\nexport function getHighlights(highlights: PassageHighlight[]): PassageHighlight[] {\n  return highlights\n}\n\n/**\n * Remove highlight at exact passage\n */\nexport function removeHighlight(\n  highlights: PassageHighlight[],\n  passage: PassageTuple\n): PassageHighlight[] {\n  const key = getPassageKey(passage)\n  return highlights.filter(h => getPassageKey(h.passage) !== key)\n}\n\n/**\n * Add a highlight - does not mutate input\n */\nexport function addHighlight(\n  highlights: PassageHighlight[],\n  passage: PassageTuple,\n  colorId: string\n): PassageHighlight[] {\n  const [book, chapter, start, end] = passage\n\n  const overlapping = getOverlappingHighlights(highlights, passage)\n\n  // Remove overlapping highlights\n  const result = highlights.filter(\n    h => !overlapping.some(o => getPassageKey(o.passage) === getPassageKey(h.passage))\n  )\n\n  // Merge same-color overlapping ranges\n  const sameColorOverlapping = overlapping.filter(h => h.highlightColorId === colorId)\n  let mergedStart = start\n  let mergedEnd = end\n\n  if (sameColorOverlapping.length > 0) {\n    sameColorOverlapping.forEach(h => {\n      const [, , hStart, hEnd] = h.passage\n      mergedStart = Math.min(mergedStart, hStart)\n      mergedEnd = Math.max(mergedEnd, hEnd)\n    })\n  }\n\n  const newHighlight: PassageHighlight = {\n    passage: [book, chapter, mergedStart, mergedEnd],\n    highlightColorId: colorId,\n  }\n\n  return [...result, newHighlight]\n}\n\n/**\n * Remove overlapping highlights of the same color and create remainders\n */\nfunction removeOverlappingAndCreateRemainders(\n  highlights: PassageHighlight[],\n  passage: PassageTuple,\n  activeColorId: string\n): PassageHighlight[] {\n  const [, , start, end] = passage\n  const overlapping = getOverlappingHighlights(highlights, passage)\n\n  // Start with highlights that are not overlapping\n  let result = highlights.filter(\n    h => !overlapping.some(o => getPassageKey(o.passage) === getPassageKey(h.passage))\n  )\n\n  overlapping\n    .filter(h => h.highlightColorId === activeColorId)\n    .forEach(highlight => {\n      const [hBook, hChapter, hStart, hEnd] = highlight.passage\n\n      // Create highlight for verses before the removed range\n      if (hStart < start) {\n        result = addHighlight(result, [hBook, hChapter, hStart, start - 1], highlight.highlightColorId)\n      }\n\n      // Create highlight for verses after the removed range\n      if (hEnd > end) {\n        result = addHighlight(result, [hBook, hChapter, end + 1, hEnd], highlight.highlightColorId)\n      }\n    })\n\n  return result\n}\n\n/**\n * Toggle highlight on a passage\n */\nexport function toggleHighlight(\n  highlights: PassageHighlight[],\n  passage: PassageTuple,\n  activeColorId: string\n): PassageHighlight[] {\n  const [book, chapter, start, end] = passage\n\n  // Empty selection check\n  if (start == null || end == null) return highlights\n\n  const overlapping = getOverlappingHighlights(highlights, passage)\n  const sameColorHighlights = overlapping.filter(h => h.highlightColorId === activeColorId)\n  const differentColorHighlights = overlapping.filter(h => h.highlightColorId !== activeColorId)\n\n  let hasExactMatch = false\n  for (const highlight of sameColorHighlights) {\n    const [, , hStart, hEnd] = highlight.passage\n    if (hStart === start && hEnd === end) {\n      hasExactMatch = true\n      break\n    }\n  }\n\n  // Case 1: No overlapping highlights - add new highlight\n  if (overlapping.length === 0) {\n    return addHighlight(highlights, passage, activeColorId)\n  }\n\n  // Case 2: Exact match with same color - remove it and create remainders\n  if (hasExactMatch) {\n    return removeOverlappingAndCreateRemainders(highlights, passage, activeColorId)\n  }\n\n  // Case 3: Single verse toggle or overlapping with any highlights\n  if (start === end || overlapping.length > 0) {\n    let shouldAddHighlight = true\n\n    // Start by removing all overlapping highlights from result\n    let result = highlights.filter(\n      h => !overlapping.some(o => getPassageKey(o.passage) === getPassageKey(h.passage))\n    )\n\n    // Handle overlapping same color highlights\n    sameColorHighlights.forEach(h => {\n      const [hBook, hChapter, hStart, hEnd] = h.passage\n\n      // Create non-overlapping highlight sections\n      if (hStart < start) {\n        result = addHighlight(result, [hBook, hChapter, hStart, start - 1], activeColorId)\n      }\n      if (hEnd > end) {\n        result = addHighlight(result, [hBook, hChapter, end + 1, hEnd], activeColorId)\n      }\n\n      // Don't add a new highlight if we're toggling a single verse that was highlighted\n      if (start === end && hStart <= start && hEnd >= end) {\n        shouldAddHighlight = false\n      }\n    })\n\n    // Handle different color highlights\n    differentColorHighlights.forEach(h => {\n      const [hBook, hChapter, hStart, hEnd] = h.passage\n      // Preserve highlights outside the selected range\n      if (hStart < start) {\n        result = addHighlight(result, [hBook, hChapter, hStart, start - 1], h.highlightColorId)\n      }\n      if (hEnd > end) {\n        result = addHighlight(result, [hBook, hChapter, end + 1, hEnd], h.highlightColorId)\n      }\n    })\n\n    if (shouldAddHighlight) {\n      result = addHighlight(result, passage, activeColorId)\n    }\n\n    return result\n  }\n\n  // Case 4: Extending/merging same color highlights\n  if (sameColorHighlights.length > 0) {\n    let mergedStart = start\n    let mergedEnd = end\n    sameColorHighlights.forEach(h => {\n      const [, , hStart, hEnd] = h.passage\n      mergedStart = Math.min(mergedStart, hStart)\n      mergedEnd = Math.max(mergedEnd, hEnd)\n    })\n\n    // Remove all overlapping and add merged\n    let result = highlights.filter(\n      h => !overlapping.some(o => getPassageKey(o.passage) === getPassageKey(h.passage))\n    )\n    result = addHighlight(result, [book, chapter, mergedStart, mergedEnd], activeColorId)\n    return result\n  }\n\n  // Default: add new highlight\n  return addHighlight(highlights, passage, activeColorId)\n}\n\n/**\n * Clear all highlights\n */\n// eslint-disable-next-line @typescript-eslint/no-unused-vars\nexport function clearAllHighlights(_highlights: PassageHighlight[]): PassageHighlight[] {\n  return []\n}\n\n/**\n * Clear highlights of a specific color\n */\nexport function clearColorHighlights(\n  highlights: PassageHighlight[],\n  colorId: string\n): PassageHighlight[] {\n  return highlights.filter(h => h.highlightColorId !== colorId)\n}\n\n/**\n * Backwards-compatible wrapper class.\n * Keeps state at the instance level and delegates to pure functions.\n */\nexport class Highlighter {\n  private highlights: PassageHighlight[]\n\n  constructor(initialHighlights: PassageHighlight[] = []) {\n    this.highlights = [...initialHighlights]\n  }\n\n  addHighlight(passage: PassageTuple, colorId: string) {\n    this.highlights = addHighlight(this.highlights, passage, colorId)\n  }\n\n  removeHighlight(passage: PassageTuple) {\n    this.highlights = removeHighlight(this.highlights, passage)\n  }\n\n  toggleHighlight(passage: PassageTuple, activeColorId: string) {\n    this.highlights = toggleHighlight(this.highlights, passage, activeColorId)\n  }\n\n  getHighlightForVerse(book: number, chapter: number, verse: number) {\n    return getHighlightForVerse(this.highlights, book, chapter, verse)\n  }\n\n  getExactPassageHighlight(passage: PassageTuple) {\n    return getExactPassageHighlight(this.highlights, passage)\n  }\n\n  getOverlappingHighlights(passage: PassageTuple) {\n    return getOverlappingHighlights(this.highlights, passage)\n  }\n\n  getHighlights() {\n    return this.highlights\n  }\n\n  clearColorHighlights(colorId: string) {\n    this.highlights = clearColorHighlights(this.highlights, colorId)\n  }\n\n  clearAllHighlights() {\n    this.highlights = clearAllHighlights(this.highlights)\n  }\n}\n"]}